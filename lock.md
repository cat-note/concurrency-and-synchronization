# 锁

### mutex
互斥量也称互斥锁, 同一时间只能持有一个锁, 不同持有者之间是互斥的.

在已经有一个持有者的情况下, 其他持有者阻塞等待(当然都有try lock等操作), 直到当前持有者unlock, 才轮到下一个lock.

阻塞等待的时候, mutex会让当前线程休眠, 交由内核调度, 线程会在上一位持有者unlock的时候唤醒来竞争锁.

### spinlock
内旋锁, 据我看到的中文文章, spinlock跟mutex是很相似的, 主要区别在阻塞的方式上.

内旋锁阻塞等待的方式非常简单粗暴, 那就是whlie(true). 写过死循环的都会知道, 这种操作会白吃cpu做无用功, 但是好处在于线程不会休眠, 也就不会有上下文切换, 没有上下文切换的开销.

也因为这个原因, spinlock不能在单核cpu上阻塞, 因为会吃满一个核, 那么在单核的情况下根本不存在第二者来解开lock, 会造成死循环.

实际上很少用到spinlock, 除非你知道自己在做什么.

### rwlock
读写锁, 共享读, 独享写.

在写锁lock的时候, 不允许有其他任何读/写锁. 在读锁lock的时候, 允许其他读锁, 不允许写锁.

在多读少写的场景有用, 但是开销会比mutex大.

##### 读优先锁/写优先锁
顾名思义, 在后面有n个读锁和n个写锁排队等待lock的情况下, 读优先锁优先允许读锁, 写优先锁优先允许写锁.

#### 公平锁
公平锁指的是在申请锁的时候, 按申请的先后顺序来持有锁. 内部一般会有一个fifo通道/队列, 根据先申请先获得的原则(我自己的表达).
